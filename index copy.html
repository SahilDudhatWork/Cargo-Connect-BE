<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Notifications</title>
    <style>
      /* Base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #2b2b2b;
        padding: 20px;
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
        color: #ffffff;
      }

      /* Notification bar styling */
      #notification-bar {
        border: 1px solid #ccc;
        padding: 20px;
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 400px;
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        z-index: 999;
      }

      /* Notification card styling */
      .notification {
        margin: 10px 0;
        padding: 15px;
        background-color: #e7f1ff;
        border-left: 4px solid #007bff;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        animation: fadeIn 0.3s ease-in;
      }

      /* Fade-in animation for notifications */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Notification text styling */
      .notification strong {
        font-size: 1.1em;
        color: #007bff;
      }

      .notification p {
        margin-top: 5px;
        font-size: 0.85em;
        color: #555;
      }

      /* Delete button styling */
      .delete-button {
        cursor: pointer;
        color: #ff4b4b;
        font-weight: bold;
        font-size: 1.2em;
        margin-left: 10px;
        transition: color 0.2s ease;
      }

      .delete-button:hover {
        color: #d32f2f;
      }

      /* Responsive adjustments */
      @media (max-width: 600px) {
        #notification-bar {
          max-width: 100%;
          right: 10px;
          left: 10px;
        }
      }
    </style>
    <script>
      let socket;
      let currentUserId;

      // Load notifications from localStorage
      function loadNotificationsFromLocalStorage(userId) {
        const notifications =
          JSON.parse(localStorage.getItem(`notifications_${userId}`)) || [];
        notifications.forEach(displayNotification);
      }

      // Save new notification to localStorage
      function saveNotificationToLocalStorage(notification) {
        const userId = notification.userId;
        const notifications =
          JSON.parse(localStorage.getItem(`notifications_${userId}`)) || [];
        notifications.push(notification);
        localStorage.setItem(
          `notifications_${userId}`,
          JSON.stringify(notifications)
        );
      }

      // Connect WebSocket
      function connectWebSocket(userId) {
        socket = new WebSocket(`ws://localhost:3000/ws/${userId}`);

        socket.onopen = function () {
          console.log(`WebSocket connection established for user ${userId}`);
        };

        socket.onmessage = function (event) {
          const message = JSON.parse(event.data);
          if (message.type === "NEW_NOTIFICATION") {
            displayNotification(message.data);
            saveNotificationToLocalStorage(message.data);
          }
        };

        socket.onclose = function () {
          console.log(`WebSocket connection closed for user ${userId}`);
        };

        socket.onerror = function (error) {
          console.error("WebSocket error:", error);
        };
      }

      // Display notification on the UI
      function displayNotification(notification) {
        const notificationBar = document.getElementById("notification-bar");
        const notificationDiv = document.createElement("div");
        notificationDiv.className = "notification";
        notificationDiv.innerHTML = `
          <div>
            <strong>${notification.title}</strong>
            <p>${notification.body}</p>
            <p><small>${notification.currentDateTime}</small></p>
          </div>
          <span class="delete-button" onclick="deleteNotification(this, '${notification.id}', '${notification.userId}')">âœ–</span>
        `;
        notificationBar.appendChild(notificationDiv);
      }

      // Delete notification
      function deleteNotification(element, notificationId, userId) {
        const notificationDiv = element.parentElement;
        notificationDiv.remove();

        // Remove from localStorage
        const notifications =
          JSON.parse(localStorage.getItem(`notifications_${userId}`)) || [];
        const updatedNotifications = notifications.filter(
          (n) => n.id !== notificationId
        );
        localStorage.setItem(
          `notifications_${userId}`,
          JSON.stringify(updatedNotifications)
        );
      }

      // Switch user and reload their notifications
      function switchUser(userId) {
        currentUserId = userId;
        loadNotificationsFromLocalStorage(userId);

        if (socket) {
          socket.close();
        }
        connectWebSocket(userId);
      }

      window.onload = () => {
        currentUserId = "6706035f97458c062e656b69"; // Example userId
        connectWebSocket(currentUserId);
        loadNotificationsFromLocalStorage(currentUserId);
      };
    </script>
  </head>
  <body>
    <h1>WebSocket Notifications</h1>
    <div id="notification-bar"></div>
  </body>
</html>
